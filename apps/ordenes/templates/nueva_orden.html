{% extends "base.html" %}
{% load static %}

{% block content %} 

<div class="my-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            {# Mensajes de Django #}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" action="" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {# Errores del formulario #}
                {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="row g-3">
                            {# Oficio #}
                            <div class="col-md-3">
                                <label for="oficio" class="form-label fw-semibold">Oficio</label>
                                <input type="text" class="form-control" id="oficio" name="oficio"
                                    value="{{ form.oficio.value|default:'S/N' }}"
                                    placeholder="Ej: OF-2024-001">
                            </div>


                            {# Prioridad #}
                            <div class="col-md-3">
                                <label for="prioridad" class="form-label fw-semibold">Prioridad</label>
                                <select class="form-select" id="prioridad" name="prioridad" required>
                                    <option value="">-- Seleccione --</option>
                                    <option value="minima">Mínima</option>
                                    <option value="normal">Normal</option>
                                    <option value="programada">Programada</option>
                                    <option value="urgente">Urgente</option>
                                    <option value="inmediata">Inmediata</option>
                                </select>
                                <div class="invalid-feedback">Seleccione la prioridad.</div>
                            </div>

                            <div class="col-md-6"></div>

                            {# Usuarios (normalmente serían selects con datos de la BD) #}
                            <div class="col-md-3">
                                <label for="usuario_solicita" class="form-label fw-semibold">
                                    <i class="fas fa-user"></i> Usuario que solicita
                                </label>
                                <select class="form-select" id="usuario_solicita" name="usuario_solicita" required onchange="actualizarNombreUsuario()">
                                    <option value="1">-- Seleccione --</option>
                                    {% for usuario in usuarios %}
                                        <option value="{{ usuario.id }}" data-nombre="{{ usuario.nombre }}"
                                            {% if form.usuario_solicita.value == usuario.id %}selected{% endif %}>
                                            {{ usuario.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-9">
                                <label for="usuario_solicita_text" class="form-label fw-semibold">Nombre del usuario</label>
                                <input type="text" class="form-control" id="usuario_solicita_text"
                                    name="usuario_solicita_text"
                                    value="{{ form.usuario_solicita_text.value|default:'' }}"
                                    placeholder="Nombre del usuario" readonly>
                            </div>

                            <div class="col-md-3">
                                <label for="usuario_asigna" class="form-label">Usuario que asigna</label>
                                <select class="form-select" id="usuario_asigna" name="usuario_asigna" required>
                                    <option value="1">-- Seleccione --</option>
                                    {% for usuario in usuarios %}
                                        <option value="{{ usuario.id }}" {% if form.usuario_asigna.value == usuario.id %}selected{% endif %}>
                                            {{ usuario.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Seleccione el usuario que asigna.</div>
                            </div>

                            <div class="col-md-9">
                                <label for="usuario_solicita_text" class="form-label fw-semibold">Nombre del usuario</label>
                                <input type="text" class="form-control" id="usuario_solicita_text"
                                    name="usuario_solicita_text"
                                    value="{{ form.usuario_solicita_text.value|default:'' }}"
                                    placeholder="Nombre del usuario" readonly>
                            </div>

                            <!-- Linea separadora -->
                            <div class="col-12">
                                <hr>
                                <p class="">Detalles de la orden:</p>
                            </div>

                            {# Aplicación #}
                            <div class="col-md-4">
                                <label for="{{ form.aplicacion.id_for_label }}" class="form-label">Aplicación</label>
                                {{ form.aplicacion }}
                                <div class="invalid-feedback">Seleccione una aplicación.</div>
                            </div>

                            {# Clasificación #}
                            <div class="col-md-4">
                                <label for="{{ form.clasificacion.id_for_label }}" class="form-label"> Clasificación </label>
                                {{ form.clasificacion }}
                                <div class="invalid-feedback">Seleccione una clasificación.</div>
                            </div>

                            {# Problema #}
                            <div class="col-md-4">
                                <label for="{{ form.problema.id_for_label }}" class="form-label"> Problema </label>
                                {{ form.problema }}
                                <div class="invalid-feedback">Seleccione un problema.</div>
                            </div>

                            {# Descripción detallada #}
                            <div class="col-12">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripción / Problema / Petición</label>
                                {{ form.descripcion }}
                                <div class="invalid-feedback">La descripción detallada es obligatoria.</div>
                            </div>

                            <div class="col-md-12">
                                <hr>
                                <p>Responsables</p>
                            </div>

                            {# Asignar usuario - Solución final #}
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.usuarios_asignados.id_for_label }}" class="form-label">
                                        {{ form.usuarios_asignados.label }}
                                    </label>
                                    {{ form.usuarios_asignados }}
                                    <div class="form-text text-muted">
                                        Mantén presionada la tecla <kbd>Ctrl</kbd> (Windows) o <kbd>Cmd</kbd> (Mac) para seleccionar varios usuarios.
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Usuarios seleccionados</label>
                                    <table class="table table-bordered table-sm" id="tablaUsuariosSeleccionados">
                                        <thead class="table-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Nombre de usuario</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="2" class="text-center text-muted">Sin usuarios seleccionados</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="row g-3">
                                <!-- Select para decidir si se agregará equipo -->
                                <div class="col-md-6">
                                    <label for="tiene_equipo" class="form-label">¿Agregar equipo a la orden?</label>
                                    <select id="tiene_equipo" name="tiene_equipo" class="form-select">
                                        <option value="">Seleccione una opción</option>
                                        <option value="si">Sí</option>
                                        <option value="no">No</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Formulario de equipo (oculto inicialmente) -->
                            <div id="formularioEquipo" style="display:none; margin-top: 1rem;">
                                <h5>Datos del equipo</h5>
                                <div class="row g-3">
                                    

                                    <div class="col-md-2">
                                        <label for="{{ form_equipo.entregado_foraneo.id_for_label }}" class="form-label">Entregado foráneo</label>
                                        {{ form_equipo.entregado_foraneo }}
                                    </div>

                                    <div class="col-md-5">
                                        <label for="patrimonio" class="form-label"># Patrimonio</label>
                                        <input type="text" class="form-control" id="patrimonio" name="patrimonio"
                                            disabled>
                                    </div>

                                    <div class="col-md-5">
                                        <label for="serie" class="form-label"># Serie</label>
                                        <input type="text" class="form-control" id="serie" name="serie"
                                             disabled>
                                    </div>

                                    <div class="col-md-4">
                                        <label for="equipo" class="form-label">Equipo</label>
                                        <input type="text" class="form-control" id="equipo" name="equipo"
                                             disabled>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <label for="{{ form_equipo.marca.id_for_label }}" class="form-label">Marca</label>
                                        {{ form_equipo.marca }}
                                    </div>

                                    <div class="col-md-4">
                                        <label for="{{ form_equipo.color.id_for_label }}" class="form-label">Color</label>
                                        {{ form_equipo.color }}
                                    </div>
                                </div>
                            </div>


                

                        </div>
                    </div>

                    <div class="card-footer text-end">
                        <a href="" class="btn btn-secondary me-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary">Guardar orden</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}

<script defer src="{% static 'js/nueva_orden.js' %}"></script>
{% endblock %}
{% endblock %}
